#!/usr/bin/env bash

#
# setup
#
pushd `pwd` # save original path
cd `dirname "$0"` # cd to script path
./common/check-dependencies "shyaml weechat weechat-plugins gpm python-potr" || exit $?
./common/check-running-processes "gpm" || exit $?

#
# script
#
echo "----- enabling tor..."

weechat -r "/proxy add tor socks5 127.0.0.1 9050;/quit"

echo "----- enabling otr..."

weechat -r "/script install otr.py;/wait 500ms /quit"

echo "----- disabling logs..."

weechat -r "/set logger.level.irc 0; /quit"

echo "----- enabling ui niceties..."

cmd1="/mouse enable" # click on buffers!
cmd2="/filter add irc_smart * irc_smart_filter *" # filter out join/leave mgs
cmd3="/script install buffers.pl;/wait 500ms" # show buffers list in left aside
weechat -r "${cmd1};${cmd2};${cmd3};/quit"

echo "----- configuring irc servers..."

names=`cat conf.yaml | shyaml keys servers`

get-config(){
  name=$1; config=$2
  cat conf.yaml |
    shyaml get-value "servers.${name}.${config}" |
    sed "s/True/-${config}/g" |
    sed "s/False//g"
}
  
for name in $names
do
  domain=`get-config ${name} domain`
  ssl_flag=`get-config ${name} ssl`
  cmd1="/server add ${name} ${domain} ${ssl_flag} -autoconnect"
  cmd2="/set irc.server.${name}.proxy 'tor'"
  weechat -r "${cmd1};${cmd2};/quit"
done

# TODO
# - create .env files w/ nicks & passwords for given user on given servers
# - enable SASL & register nicks for indymedia, oftc, freenode
#  (*must* do this to connect to either oftc or freenode )
# - create a `run-weechat` script that identifies all nicks

#
# cleanup
#
popd
